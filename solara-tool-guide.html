<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Solara Tool Builder Assistant</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Optional: Tailwind theme colors (so you can use text-pano-navy etc.) -->
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              pano: {
                navy: "#161242",
                green: "#1FAA4A",
                blue: "#006DB0",
                lightgray: "#EEEEEE",
              },
              secondary: {
                turquoise: "#108A7D",
                teal: "#00A1BB",
                lavender: "#867EBB",
                lime: "#9FCC3B",
              },
            },
          },
        },
      };
    </script>

    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- React UMD + ReactDOM UMD -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel (so JSX runs in-browser) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide icons (global `lucide`) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
      .custom-scrollbar::-webkit-scrollbar {
        width: 4px;
      }
      .custom-scrollbar::-webkit-scrollbar-track {
        background: transparent;
      }
      .custom-scrollbar::-webkit-scrollbar-thumb {
        background: #e2e8f0;
        border-radius: 10px;
      }
    </style>
  </head>

  <body class="min-h-screen bg-slate-50 font-[Inter] text-slate-900">
    <div id="root"></div>

    <script type="text/babel">
      const { useState } = React;

      // Lucide Icon Wrapper
      const Icon = ({ name, ...props }) => {
        const LucideIcon = lucide[name];
        return LucideIcon ? <LucideIcon {...props} /> : null;
      };

      // --- BRAND COLORS (optional; mostly replaced by Tailwind theme) ---
      const PANO_NAVY = "#161242";
      const PANO_GREEN = "#1FAA4A";

      // --- GEMINI ---
      // DO NOT hardcode a real key in GitHub. Leave blank or use prompt below.
      let apiKey = "";

      function getApiKey() {
        // If already set in this session, return it
        if (apiKey) return apiKey;

        // Ask user once per session (safer than committing to GitHub)
        const input = window.prompt(
          "Paste your Gemini API key (it will only be used in your browser for this session):"
        );
        apiKey = (input || "").trim();
        return apiKey;
      }

      const callGemini = async (userQuery, retryCount = 0) => {
        const key = getApiKey();
        if (!key) throw new Error("No API key provided.");

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${key}`;

        const systemPrompt = `
You are the Solara Custom Tool Assistant. Help educators design precise Custom Tools.

GUIDELINES FOR GENERATION:
1. Instructions: Use PLAIN TEXT only (no markdown, no bolding, no rule tags). Keep them relatively short but highly effective.
2. Role & Responsibilities: Instructions must establish a clear Role Identity (e.g., "You are an expert reading specialist...") and list Core Responsibilities.
3. Category: Choose from ["Family Engagement", "Instructional Planning", "Student Engagement", "Student Support"].
4. Guardrails: Do not refer to student names or IDs; assume this data is provided by the platform.

Output MUST be a valid JSON object following the responseSchema.
        `;

        const payload = {
          contents: [{ parts: [{ text: `Educator Need: ${userQuery}` }] }],
          systemInstruction: { parts: [{ text: systemPrompt }] },
          generationConfig: {
            responseMimeType: "application/json",
            responseSchema: {
              type: "OBJECT",
              properties: {
                title: { type: "STRING" },
                description: { type: "STRING" },
                instructions: { type: "STRING" },
                category: { type: "STRING" },
                categoryRationale: { type: "STRING" },
                recommendedFields: {
                  type: "ARRAY",
                  items: { type: "STRING" },
                },
              },
              required: [
                "title",
                "description",
                "instructions",
                "category",
                "categoryRationale",
                "recommendedFields",
              ],
            },
          },
        };

        try {
          const response = await fetch(url, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData?.error?.message || "API request failed");
          }

          const result = await response.json();
          const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
          if (!text) throw new Error("Empty AI response");
          return JSON.parse(text);
        } catch (error) {
          if (retryCount < 5) {
            const delay = Math.pow(2, retryCount) * 1000;
            await new Promise((resolve) => setTimeout(resolve, delay));
            return callGemini(userQuery, retryCount + 1);
          }
          throw error;
        }
      };

      // --- DATA (your categories/tools) ---
      const APP_DATA = {
        mtss: {
          id: "mtss",
          title: "MTSS and Student Support Tools",
          shortTitle: "MTSS Tools",
          icon: <Icon name="Users" className="h-5 w-5 text-pano-green" />,
          accent: "#108A7D",
          description:
            "Develop multi-tiered support systems, tiered interventions, and student assistance frameworks to improve overall student academic and behavioral outcomes.",
          summary: "Multi-tiered support systems, interventions, and student assistance.",
          tools: [
            {
              title: "SMART Goal Generator",
              category: "Student Support",
              description:
                "Helps teachers create intervention-aligned SMART goals based on student data and district expectations.",
              prompt:
                "Create a SMART goal for a student in the K–12 setting that is Specific, Measurable, Achievable, Relevant, and Time-bound... (truncated)",
              fields: [
                "Perceived need",
                "Domain (e.g., literacy, behavior)",
                "Tier of support",
                "Desired outcome timeframe",
              ],
            },
          ],
        },
        instruction: {
          id: "instruction",
          title: "Instruction and Curriculum Tools",
          shortTitle: "Curriculum Tools",
          icon: <Icon name="BookOpen" className="h-5 w-5 text-pano-green" />,
          accent: "#00A1BB",
          description: "Lesson planning, curriculum development, and instructional strategies.",
          summary: "Lesson planning, curriculum development, and instructional strategies.",
          tools: [
            {
              title: "Rubric Generator",
              category: "Instructional Planning",
              description:
                "Builds grading rubrics aligned to standards, success criteria, and assignment goals.",
              prompt:
                "Generate a detailed rubric for a K–12 assignment, fully aligned to the provided learning standard...",
              fields: ["Assignment description", "Learning objectives", "Performance levels"],
            },
          ],
        },
        attendance: {
          id: "attendance",
          title: "Attendance Tools",
          shortTitle: "Attendance Tools",
          icon: <Icon name="Calendar" className="h-5 w-5 text-pano-green" />,
          accent: "#9FCC3B",
          description: "Tracking, analyzing, and improving student attendance patterns.",
          summary: "Tracking, analyzing, and improving student attendance patterns.",
          tools: [
            {
              title: "Attendance Contract Generator",
              category: "Student Support",
              description:
                "Drafts personalized attendance improvement contracts that outline shared expectations.",
              prompt:
                "Generate a student-centered attendance contract for a K–12 student that is collaborative...",
              fields: ["Identified barriers", "Support strategies", "Contract timeframe"],
            },
          ],
        },
        family: {
          id: "family",
          title: "Family Engagement Tools",
          shortTitle: "Family Engagement",
          icon: <Icon name="Heart" className="h-5 w-5 text-pano-green" />,
          accent: "#867EBB",
          description: "Building stronger connections between families, students, and schools.",
          summary: "Building stronger connections between families, students, and schools.",
          tools: [
            {
              title: "Family Update Generator",
              category: "Family Engagement",
              description: "Drafts regular, personalized updates to families about student progress.",
              prompt:
                "Create a biweekly family update for a K–12 student that summarizes academic progress...",
              fields: ["Progress highlights", "Home support suggestions", "Upcoming events"],
            },
          ],
        },
      };

      // --- Components ---
      function ToolCard({ tool, accentColor, onCopy, initiallyExpanded = false }) {
        const [isExpanded, setIsExpanded] = useState(initiallyExpanded);
        const [copied, setCopied] = useState(false);

        const copyText = async (e) => {
          e.stopPropagation();
          await navigator.clipboard.writeText(tool.prompt || "");
          setCopied(true);
          setTimeout(() => setCopied(false), 1500);
        };

        return (
          <div className="overflow-hidden rounded-xl border border-slate-200 bg-white shadow-sm">
            <button
              onClick={() => setIsExpanded(!isExpanded)}
              className="w-full text-left"
            >
              <div className="flex items-start justify-between gap-4 p-6 hover:bg-slate-50">
                <div>
                  <div className="text-2xl font-bold text-pano-navy">{tool.title}</div>
                  <div className="mt-2 text-slate-600">{tool.description}</div>
                </div>
                <Icon
                  name="ChevronDown"
                  className={
                    "h-6 w-6 text-slate-400 transition-transform " +
                    (isExpanded ? "rotate-180" : "")
                  }
                />
              </div>
            </button>

            {isExpanded && (
              <div className="border-t border-slate-100 p-6">
                <div className="flex items-center justify-between">
                  <div className="text-xs font-bold uppercase tracking-widest text-slate-500">
                    Tool Instructions
                  </div>
                  <button
                    onClick={copyText}
                    className={
                      "rounded-lg px-3 py-2 text-xs font-bold text-white " +
                      (copied ? "bg-green-600" : "bg-blue-600")
                    }
                  >
                    {copied ? "Copied!" : "Copy"}
                  </button>
                </div>

                <div
                  className="mt-4 whitespace-pre-wrap rounded-xl border border-slate-100 bg-pano-lightgray p-4 text-sm italic text-slate-700"
                  style={{ borderLeft: `4px solid ${accentColor || PANO_GREEN}` }}
                >
                  {tool.prompt}
                </div>

                <div className="mt-6 grid gap-6 sm:grid-cols-2">
                  <div>
                    <div className="text-xs font-bold uppercase tracking-widest text-slate-500">
                      Category
                    </div>
                    <div className="mt-2 inline-flex rounded-lg bg-slate-800 px-3 py-1 text-xs font-bold text-white">
                      {tool.category}
                    </div>
                  </div>

                  <div>
                    <div className="text-xs font-bold uppercase tracking-widest text-slate-500">
                      Recommended Fields
                    </div>
                    <ul className="mt-3 space-y-2">
                      {(tool.fields || []).map((f, idx) => (
                        <li key={idx} className="flex items-center gap-2 text-sm text-slate-600">
                          <span
                            className="h-2 w-2 rounded-full"
                            style={{ backgroundColor: accentColor || PANO_GREEN }}
                          ></span>
                          {f}
                        </li>
                      ))}
                    </ul>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      function ToolBuilderView({ onToolGenerated, drafts, onExport }) {
        const [userInput, setUserInput] = useState("");
        const [loading, setLoading] = useState(false);
        const [result, setResult] = useState(null);
        const [error, setError] = useState("");

        const generate = async () => {
          if (!userInput.trim()) return;
          setLoading(true);
          setError("");
          setResult(null);
          try {
            const data = await callGemini(userInput.trim());
            setResult(data);
            onToolGenerated(data);
          } catch (e) {
            setError(e.message || "Something went wrong.");
          } finally {
            setLoading(false);
          }
        };

        return (
          <div className="space-y-10">
            <div className="flex flex-col gap-4 md:flex-row md:items-end md:justify-between">
              <div>
                <h2 className="text-4xl font-bold text-pano-navy">Solara Tool Builder Assistant</h2>
                <p className="mt-2 text-slate-600">
                  Describe a classroom challenge and AI will draft a tool for you.
                </p>
              </div>

              {drafts.length > 0 && (
                <button
                  onClick={onExport}
                  className="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-4 py-2 text-sm font-bold text-slate-700 hover:bg-slate-50"
                >
                  <Icon name="Download" className="h-4 w-4" />
                  Export History
                </button>
              )}
            </div>

            <div className="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
              <textarea
                className="h-40 w-full rounded-xl border border-slate-200 bg-slate-50 p-4 outline-none focus:ring-2 focus:ring-green-500"
                placeholder="e.g., I need a tool for..."
                value={userInput}
                onChange={(e) => setUserInput(e.target.value)}
              ></textarea>

              <button
                onClick={generate}
                disabled={loading || !userInput.trim()}
                className="mt-4 flex w-full items-center justify-center gap-2 rounded-xl bg-pano-navy py-3 text-lg font-bold text-white disabled:opacity-50"
              >
                {loading ? (
                  <Icon name="Loader2" className="h-5 w-5 animate-spin" />
                ) : (
                  <Icon name="Sparkles" className="h-5 w-5 text-yellow-300" />
                )}
                {loading ? "Drafting..." : "Draft My Tool"}
              </button>

              {error && (
                <div className="mt-4 rounded-xl border border-red-100 bg-red-50 p-3 text-sm text-red-700">
                  {error}
                </div>
              )}
            </div>

            {result && (
              <ToolCard
                tool={{
                  title: result.title,
                  description: result.description,
                  category: result.category,
                  prompt: result.instructions,
                  fields: result.recommendedFields,
                }}
                accentColor="#00A1BB"
                initiallyExpanded={true}
              />
            )}
          </div>
        );
      }

      function App() {
        const [activeView, setActiveView] = useState("home");
        const [activeCategory, setActiveCategory] = useState(null);
        const [sidebarOpen, setSidebarOpen] = useState(false);
        const [drafts, setDrafts] = useState([]);

        const categoryOrder = ["instruction", "mtss", "attendance", "family"];

        const currentCategory = activeCategory ? APP_DATA[activeCategory] : null;

        const exportHistory = () => {
          const content = JSON.stringify(drafts, null, 2);
          const blob = new Blob([content], { type: "text/plain" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "tool_drafts.txt";
          a.click();
        };

        return (
          <div className="flex min-h-screen">
            {/* Sidebar */}
            <aside
              className={
                "fixed inset-y-0 left-0 z-40 w-72 transform border-r border-slate-200 bg-white transition-transform lg:static lg:translate-x-0 " +
                (sidebarOpen ? "translate-x-0" : "-translate-x-full")
              }
            >
              <div className="flex h-full flex-col p-6">
                <div className="flex items-center justify-between">
                  <div className="text-xl font-bold text-pano-navy">Solara Guide</div>
                  <button className="lg:hidden" onClick={() => setSidebarOpen(false)}>
                    <Icon name="X" className="h-5 w-5" />
                  </button>
                </div>

                <div className="mt-6 space-y-2">
                  <button
                    className={
                      "flex w-full items-center gap-3 rounded-xl px-4 py-3 " +
                      (activeView === "home" ? "bg-slate-100 font-bold" : "")
                    }
                    onClick={() => {
                      setActiveView("home");
                      setActiveCategory(null);
                      setSidebarOpen(false);
                    }}
                  >
                    <Icon name="Home" className="h-5 w-5" />
                    Home
                  </button>

                  <button
                    className={
                      "flex w-full items-center gap-3 rounded-xl px-4 py-3 " +
                      (activeView === "builder" ? "bg-slate-100 font-bold" : "")
                    }
                    onClick={() => {
                      setActiveView("builder");
                      setActiveCategory(null);
                      setSidebarOpen(false);
                    }}
                  >
                    <Icon name="Wand2" className="h-5 w-5 text-amber-500" />
                    Tool Assistant
                  </button>
                </div>

                <div className="mt-6 text-xs font-bold uppercase tracking-widest text-slate-400">
                  Categories
                </div>

                <nav className="custom-scrollbar mt-2 flex-1 space-y-2 overflow-y-auto">
                  {categoryOrder.map((id) => (
                    <button
                      key={id}
                      className={
                        "flex w-full items-center gap-3 rounded-xl px-4 py-2.5 " +
                        (activeCategory === id ? "bg-slate-100 font-bold" : "")
                      }
                      onClick={() => {
                        setActiveCategory(id);
                        setActiveView("home");
                        setSidebarOpen(false);
                      }}
                    >
                      {APP_DATA[id].icon}
                      {APP_DATA[id].shortTitle}
                    </button>
                  ))}
                </nav>
              </div>
            </aside>

            {/* Main */}
            <div className="flex flex-1 flex-col">
              <header className="sticky top-0 z-30 flex h-16 items-center gap-4 border-b border-slate-200 bg-white px-6">
                <button className="lg:hidden" onClick={() => setSidebarOpen(true)}>
                  <Icon name="Menu" className="h-6 w-6" />
                </button>
                <div className="text-sm text-slate-500">
                  Static GitHub Pages version (no installs)
                </div>
              </header>

              <main className="mx-auto w-full max-w-6xl p-6 md:p-10">
                {activeView === "builder" ? (
                  <ToolBuilderView
                    drafts={drafts}
                    onExport={exportHistory}
                    onToolGenerated={(tool) => setDrafts((prev) => [tool, ...prev])}
                  />
                ) : activeCategory ? (
                  <div className="space-y-6">
                    <div className="rounded-2xl border border-slate-200 bg-white p-6 shadow-sm">
                      <div className="flex items-center gap-4">
                        <div className="rounded-full bg-slate-50 p-3">{currentCategory.icon}</div>
                        <div>
                          <div className="text-2xl font-bold text-slate-900">
                            {currentCategory.title}
                          </div>
                          <div className="mt-1 text-slate-600">{currentCategory.description}</div>
                        </div>
                      </div>
                    </div>

                    {currentCategory.tools.map((t, idx) => (
                      <ToolCard
                        key={idx}
                        tool={t}
                        accentColor={currentCategory.accent}
                        initiallyExpanded={false}
                      />
                    ))}
                  </div>
                ) : (
                  <div className="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
                    {categoryOrder.map((id) => (
                      <button
                        key={id}
                        onClick={() => setActiveCategory(id)}
                        className="rounded-2xl border border-slate-200 bg-white p-6 text-left shadow-sm transition hover:shadow-md"
                      >
                        <div className="mb-3">{APP_DATA[id].icon}</div>
                        <div className="text-lg font-bold">{APP_DATA[id].title}</div>
                        <div className="mt-1 text-sm text-slate-500">{APP_DATA[id].summary}</div>
                      </button>
                    ))}
                  </div>
                )}
              </main>
            </div>
          </div>
        );
      }

      // Mount
      const root = ReactDOM.createRoot(document.getElementById("root"));
      root.render(<App />);
    </script>
  </body>
</html>
